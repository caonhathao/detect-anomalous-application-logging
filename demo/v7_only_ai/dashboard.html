<!DOCTYPE html>
<html>
<head>
    <title>Real-Time Log Analysis Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { box-sizing: border-box; }

        body {
            font-family: Arial, sans-serif;
            background: #111;
            color: #eee;
            margin: 0;
            padding: 20px;
        }

        .container { max-width: 1200px; margin: 0 auto; }
        h1 { margin-top: 0; }

        .metrics-card {
            margin-bottom: 20px;
            padding: 10px 16px;
            background: #222;
            border-radius: 8px;
            width: 100%;
            overflow-x: auto;
        }

        .metrics-card table {
            width: 100%;
            color: #eee;
            font-size: 16px;
        }

        .charts-row {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 20px;
        }

        .chart-card {
            background: #222;
            border-radius: 8px;
            padding: 10px;
            flex: 1 1 320px;
            min-width: 0;
        }

        .chart-wrapper {
            position: relative;
            width: 100%;
            height: 260px;
        }

        .full-width-chart {
            background: #222;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }

        .full-width-chart .chart-wrapper {
            height: 280px;
        }

        @media (max-width: 768px) {
            .metrics-card table { font-size: 14px; }
        }
    </style>
</head>

<body>
<div class="container">
    <h1>‚ö° Real-Time Log Analysis Dashboard</h1>
    <p>(T·ª± c·∫≠p nh·∫≠t m·ªói 5 gi√¢y)</p>

    <!-- METRIC SUMMARY L1 -->
    <div class="metrics-card">
        <h2>üìä Evaluation Metrics ‚Äî L1 (Request Level)</h2>
        <table>
            <tr>
                <td>Precision:</td><td id="precision">0</td>
                <td>Recall:</td><td id="recall">0</td>
                <td>F1-score:</td><td id="f1">0</td>
            </tr>
            <tr>
                <td>TP:</td><td id="tp">0</td>
                <td>FP:</td><td id="fp">0</td>
                <td>TN:</td><td id="tn">0</td>
                <td>FN:</td><td id="fn">0</td>
            </tr>
            <tr>
                <td>RPS:</td><td id="rps">0</td>
                <td>TPS:</td><td id="tps">0</td>
                <td>Avg Latency (ms):</td><td id="avg_latency">0</td>
            </tr>
        </table>
    </div>

    <!-- METRIC SUMMARY L2 -->
    <div class="metrics-card">
        <h2>üìÅ Evaluation Metrics ‚Äî L2 (File Level)</h2>
        <table>
            <tr>
                <td>Precision:</td><td id="l2_precision">0</td>
                <td>Recall:</td><td id="l2_recall">0</td>
                <td>F1-score:</td><td id="l2_f1">0</td>
            </tr>
            <tr>
                <td>TP:</td><td id="l2_tp">0</td>
                <td>FP:</td><td id="l2_fp">0</td>
                <td>TN:</td><td id="l2_tn">0</td>
                <td>FN:</td><td id="l2_fn">0</td>
            </tr>
        </table>
    </div>

    <div class="charts-row">
        <div class="chart-card">
            <h3>‚è± Avg Latency</h3>
            <div class="chart-wrapper"><canvas id="latencyChart"></canvas></div>
        </div>

        <div class="chart-card">
            <h3>üìÇ Safe / Malicious / Unknown</h3>
            <div class="chart-wrapper"><canvas id="ratioChart"></canvas></div>
        </div>
    </div>

    <div class="full-width-chart">
        <h3>üöÄ Throughput (RPS / TPS)</h3>
        <div class="chart-wrapper"><canvas id="throughputChart"></canvas></div>
    </div>
</div>


<script>
/* ------------------ COMMON OPTIONS ------------------ */
const MAX_VISIBLE_TICKS = 200;
const commonLineOptions = {
    responsive: true,
    maintainAspectRatio: false,
    scales: {
        x: {
            ticks: {
                callback: function(value, index) {
                    const total = this.chart.data.labels.length;
                    if (total <= MAX_VISIBLE_TICKS) return value;
                    const step = Math.ceil(total / MAX_VISIBLE_TICKS);
                    return index % step === 0 ? value : "";
                },
                color: "#eee"
            },
            grid: { color: "#444" }
        },
        y: {
            beginAtZero: true,
            grid: { color: "#333" },
            ticks: { color: "#eee" }
        }
    },
    plugins: {
        legend: { labels: { color: "#eee" } }
    }
};

/* ------------------ CHARTS ------------------ */
let latencyChart = new Chart(document.getElementById("latencyChart"), {
    type: "line",
    data: { labels: [], datasets: [{ label: "Avg Latency (ms)", data: [], borderColor: "cyan", tension: 0.3 }] },
    options: commonLineOptions
});

let ratioChart = new Chart(document.getElementById("ratioChart"), {
    type: "bar",
    data: { labels: ["Safe","Malicious","Unknown"], datasets: [{ label:"Count", data:[0,0,0], backgroundColor:["green","red","yellow"] }] },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: { ticks:{color:"#eee"}, grid:{display:false} },
            y: { beginAtZero:true, grid:{color:"#333"}, ticks:{color:"#eee"} }
        },
        plugins: { legend:{ labels:{color:"#eee"} } }
    }
});

let throughputChart = new Chart(document.getElementById("throughputChart"), {
    type: "line",
    data: {
        labels: [],
        datasets: [
            { label: "RPS", data: [], borderColor: "orange", tension:0.3 },
            { label: "TPS", data: [], borderColor: "lightgreen", tension:0.3 }
        ]
    },
    options: commonLineOptions
});

const MAX_POINTS = 2000;

/* ------------------ WEBSOCKET ------------------ */
let ws = new WebSocket("ws://localhost:8765");

ws.onmessage = (event) => {
    let data = JSON.parse(event.data);

    /* ---- Update Latency Chart ---- */
    latencyChart.data.labels.push(data.total);
    latencyChart.data.datasets[0].data.push(data.avg_latency * 1000);

    if (latencyChart.data.labels.length > MAX_POINTS) {
        latencyChart.data.labels.shift();
        latencyChart.data.datasets[0].data.shift();
    }
    latencyChart.update();

    /* ---- Update Ratio Chart ---- */
    ratioChart.data.datasets[0].data = [data.safe, data.malicious, data.unknown];
    ratioChart.update();

    /* ---- Update Throughput Chart ---- */
    throughputChart.data.labels.push(data.total);
    throughputChart.data.datasets[0].data.push(data.rps);
    throughputChart.data.datasets[1].data.push(data.tps);

    if (throughputChart.data.labels.length > MAX_POINTS) {
        throughputChart.data.labels.shift();
        throughputChart.data.datasets[0].data.shift();
        throughputChart.data.datasets[1].data.shift();
    }
    throughputChart.update();

    /* ---- Update L1 SUMMARY ---- */
    document.getElementById("precision").innerText = data.l1_precision.toFixed(4);
    document.getElementById("recall").innerText    = data.l1_recall.toFixed(4);
    document.getElementById("f1").innerText        = data.l1_f1.toFixed(4);

    document.getElementById("tp").innerText = data.l1_TP;
    document.getElementById("fp").innerText = data.l1_FP;
    document.getElementById("tn").innerText = data.l1_TN;
    document.getElementById("fn").innerText = data.l1_FN;

    document.getElementById("rps").innerText = data.rps.toFixed(2);
    document.getElementById("tps").innerText = data.tps.toFixed(2);
    document.getElementById("avg_latency").innerText = (data.avg_latency * 1000).toFixed(2);

    /* ---- Update L2 SUMMARY ---- */
    document.getElementById("l2_precision").innerText = data.l2_precision.toFixed(4);
    document.getElementById("l2_recall").innerText    = data.l2_recall.toFixed(4);
    document.getElementById("l2_f1").innerText        = data.l2_f1.toFixed(4);

    document.getElementById("l2_tp").innerText = data.l2_TP;
    document.getElementById("l2_fp").innerText = data.l2_FP;
    document.getElementById("l2_tn").innerText = data.l2_TN;
    document.getElementById("l2_fn").innerText = data.l2_FN;
};
</script>

</body>
</html>
